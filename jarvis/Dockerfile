FROM node:20

# Set the working directory inside the container
WORKDIR /usr/src/app

# Ensure the directory has correct permissions
RUN chown -R node:node /usr/src/app

# Copy package.json and package-lock.json (if available) to install dependencies
COPY package*.json ./

RUN npm install

# Copy the rest of the application code into the container
COPY . .

# Expose the port that the app will run on
EXPOSE 8080

# Write the service account key to a file
RUN echo 'ewogICJ0eXBlIjogInNlcnZpY2VfYWNjb3VudCIsCiAgInByb2plY3RfaWQiOiAiaGVyby1hbGxpYW5jZS1mZXVwLWRzLTI0LTI1IiwKICAicHJpdmF0ZV9rZXlfaWQiOiAiMWZlMDAxZjc0NGIwNDQyMjAwMTM2YTZlYzZhODJhMDI0OTEwNTcwOCIsCiAgInByaXZhdGVfa2V5IjogIi0tLS0tQkVHSU4gUFJJVkFURSBLRVktLS0tLVxuTUlJRXZnSUJBREFOQmdrcWhraUc5dzBCQVFFRkFBU0NCS2d3Z2dTa0FnRUFBb0lCQVFETGFIOXZFcDhTb2huelxucXpKUWlDL0NSdkxQK3cweTVxWDRKaXM3UTFMS2lQYklzcDh6NG1IMkpJNDdHN1VUOFVkZWRwaG1MZCtSUFF1RFxuL3FjeThyNGoxK1FWWUhsKzViaE01NGF6b1h2WHF6RldEYmxjQTJhRStKQzBhZVh1NnByOHhFclhNYTQrWTQ1cFxuL1FUTUNqeDB4ZXJkSk8yQ29qR1hEN1dHSlk0WXp3NFM1d2M2Qk5yYnVHUUhYeGFhMEl6Lzl2OE11RW9ia0pqclxudld0MXpvQ0lRYjRFaCtPeklqQXJGb3pMd2hiUm44ZU9FWVEwSU43MFZ1NkphRm1nVG91dDlUQ283a3kxSkRxalxuZW4zd2dmdkJ1YUhJT3F0blNWNWJ1dUcrZjNBQzlsek4zZVFtWFBLL3BKUDM4OE1FcXE3eEtJM1V1RStzbFBocVxuaVQ2NGJXV1RBZ01CQUFFQ2dnRUFZQ241b1VIcytZcXdlVDRWRGZTc200MGVTMHgxeTN3MnQvQVhuUzl4YXpaQVxuY2RiY3BGTmhHOVRoZHpsY3JONXpic25qdDk3MUpMMTIvY0s5T2oxL3ZnTlpuZStiME8zNjZVVEdMcE5vTUtpTFxuTFJOVThCYmRkM3pxTUprbUx3TTBIYzhSVU5aNGVaOW9tMXdXMGYzKzRmZ1YxdElZQlp2M2xPTEUzM1JPenhQd1xueGRDQ1VERmltK0I0T0N1bW1LcVVyR3N6a3ZrMElvS1dCV3ZHbnV2d29oVnQ0WFZVOEZwTDIyZGViUGJmSTdIcFxuaVFXS3Bya24wZDN6elhENlJaUmRjY0MwTDhGaDlsUkoyTTVob2wyNUFrb0gwYzlhUmJJQktNL0NEd2cycmNKTVxucnVlQ2g2ckdzaU00RG1qdDVUdUJ5alJBc2lkYzFEeXJzVGVIdDhKckhRS0JnUURyUmNBTy9SNElybFR1MFZFN1xuajlTZ3EyUCtEWEdiZGJSSmU4aWJwTC9qTkUvRStYYkdLeTFDTkxCKzFad3VYUWdpRytHUU1PNXdyYzN4ZnBkdFxuOEZCTlUzazg0enZuM3Q1NUJvdjZaV2E5K0NNNWxQR1JoZ3UzWkgxaG5GMHhKdXVsa0k2QkxoTHM5R0FTbmhCQ1xuOTViSHB0WHFoRmdOUDdLeHZxYXJHaVczandLQmdRRGRWQmVwazl6SGxTa0dZYWJ1bkNSRkpNR2FyNC9MdlA1Z1xuVFF1QkdUaU8rYzg2dmoyZ1IyVmticUhUbS9nWGdXY2p1L1ExdzFKTmgvenpZVk50dWN1Z3BaalZqR3F3d1VBdVxuaTJhbm1EZExIM3JJNDVTTm44aUhaRzNxWFpSMnpnMitsRG01RkcyMnBncXlBd2VYblVJdWJKdUh2QkdHMEJxS1xuTmJCTzhEU1B2UUtCZ1FEZWpMOHRMbisvaEhDdzYyMWs0eHdsMDVvbGtqLzU1ekJnSm1oUDJscnRKK21oRUwwcVxubldNVmNsUFYxbWdEYjFzbk1LcUF3OWg0Mjkrb1piQUdmY0RvTkdMRmxzbHUvMklBcDVHM2pUM1B5eTQrNU1aUlxuZXJRUWlVMFZEVjBXQnBQM3JETXd2UTJIK1czN2ptc2hmYVN5UFAyeTlmZDRxTjEyeHpwUE5jK2h2d0tCZ1FETVxuNXVwVkt6Zk5haEVtQUVmc1JZL3FsMkhKbEZrNjFJaG5uVXhXUTRReUVhSEJqNWc4QjMwZDRySmMxdHR5MzNFZVxuQ3diR3MwSkIxdkRlWFM5QXVTNkVWbXJNNFFkeEJpZ21MeFpsZUMxUWxoODFWa1FVYldYWHVxbHJ2U0VTY0NjWFxuVmVDdXNQUDFrWGo3WG9TcjM0SUN1cmV1alBWbzZzWjNSOGNtL1lpYnZRS0JnQXhzWmt5c1RNTURUay9SbDdOVFxuakx3MC9TalZ1SmVEdldmK05XempPL1M5Q0JibDBmVlJQNGlrTWIvUHV2VHpiZ1VzbnA5WkMyd0JqSlhERjQyWFxuTnB0OXduL21qcWdNbGgzVzhZc1NiVUVMWUh5d0hQb2I2WEhlN2ZWR25Lb0VtakhUcFkyeFBoOWdBRERSbUVnUlxudy9sVkxoaXdLUWJLZzQ1RllLWHNnZDhOXG4tLS0tLUVORCBQUklWQVRFIEtFWS0tLS0tXG4iLAogICJjbGllbnRfZW1haWwiOiAiaGVyby1hbGxpYW5jZS1qYXJ2aXNAaGVyby1hbGxpYW5jZS1mZXVwLWRzLTI0LTI1LmlhbS5nc2VydmljZWFjY291bnQuY29tIiwKICAiY2xpZW50X2lkIjogIjEwODk4MzYwNjI4OTE4MjI2MjU1OSIsCiAgImF1dGhfdXJpIjogImh0dHBzOi8vYWNjb3VudHMuZ29vZ2xlLmNvbS9vL29hdXRoMi9hdXRoIiwKICAidG9rZW5fdXJpIjogImh0dHBzOi8vb2F1dGgyLmdvb2dsZWFwaXMuY29tL3Rva2VuIiwKICAiYXV0aF9wcm92aWRlcl94NTA5X2NlcnRfdXJsIjogImh0dHBzOi8vd3d3Lmdvb2dsZWFwaXMuY29tL29hdXRoMi92MS9jZXJ0cyIsCiAgImNsaWVudF94NTA5X2NlcnRfdXJsIjogImh0dHBzOi8vd3d3Lmdvb2dsZWFwaXMuY29tL3JvYm90L3YxL21ldGFkYXRhL3g1MDkvaGVyby1hbGxpYW5jZS1qYXJ2aXMlNDBoZXJvLWFsbGlhbmNlLWZldXAtZHMtMjQtMjUuaWFtLmdzZXJ2aWNlYWNjb3VudC5jb20iLAogICJ1bml2ZXJzZV9kb21haW4iOiAiZ29vZ2xlYXBpcy5jb20iCn0K' > /usr/src/app/service_account_key.txt

# Set the correct ownership and permissions for the service account key
RUN chmod 600 /usr/src/app/service_account_key.txt && chown node:node /usr/src/app/service_account_key.txt

ENV SERVICE_ACCOUNT_KEY_PATH './service_account_key.txt'

# Set the environment variable for Firebase credentials
ENV GOOGLE_APPLICATION_CREDENTIALS='./service_account_key.json'


# Switch to a non-root user for security
USER node

# Start the application
CMD ["npm", "run", "dev"]
